---
import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';
import { getLangFromUrl, getStaticPaths, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export { getStaticPaths };

// // Vérifier si l'utilisateur est connecté
// const isLoggedIn = Astro.cookies.get('session')?.value;

// // Si pas connecté, rediriger vers login
// if (!isLoggedIn) {
//   return Astro.redirect(`/${lang}/log`);
// }

// Simuler les données utilisateur
const user = {
	firstName: 'Jean',
	lastName: 'Dupont',
	email: 'jean.dupont@example.com',
	phone: '+33 6 12 34 56 78',
	gender: 'male',
	createdAt: '2024-01-15',
	address: '123 Rue de la Paix, 75001 Paris',
};

// Simuler l'historique des commandes
const orders = [
	{
		id: '001',
		date: '2024-03-15',
		total: 45.5,
		status: 'delivered',
		items: 3,
	},
	{
		id: '002',
		date: '2024-03-10',
		total: 32.0,
		status: 'processing',
		items: 2,
	},
	{
		id: '003',
		date: '2024-02-28',
		total: 78.9,
		status: 'delivered',
		items: 5,
	},
];
---

<Layout title={t('account.title') || 'Mon compte'}>
	<Header />

	<!-- Banner -->
	<section
		class="relative h-[300px] w-full overflow-hidden md:h-[400px]"
		style="margin-top: 160px; position: relative; z-index: 1;"
	>
		<img
			src="/img/PANIER.jpeg"
			alt="Account Banner"
			class="block h-[400px] w-full object-cover md:h-[500px]"
		/>
		<div
			class="absolute inset-0 flex items-center justify-start bg-black/40 text-center"
		>
			<h1
				class="ml-10 font-[Chalkduster] text-4xl tracking-wide text-white md:text-7xl"
			>
				{t('account.title') || 'Mon Compte'}
			</h1>
		</div>
	</section>

	<!-- Contenu Principal -->
	<div class="container mx-auto px-4 py-12">
		<div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
			<!-- Sidebar Navigation -->
			<aside class="lg:col-span-1">
				<div class="sticky top-24 rounded-2xl bg-white p-6 shadow-lg">
					<div class="mb-6 text-center">
						<div
							class="mx-auto mb-4 flex h-24 w-24 items-center justify-center rounded-full bg-gradient-to-br from-[#5C3F32] to-[#8B4513] text-3xl font-bold text-white"
						>
							{user.firstName.charAt(0)}{user.lastName.charAt(0)}
						</div>
						<h2 class="text-xl font-bold text-[#5C3F32]">
							{user.firstName}
							{user.lastName}
						</h2>
						<p class="text-sm text-gray-600">{user.email}</p>
					</div>

					<nav class="space-y-2">
						<a
							href="#profile"
							class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors"
						>
							<svg
								class="h-5 w-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
								></path>
							</svg>
							{t('account.profile') || 'Mon profil'}
						</a>

						<a
							href="#orders"
							class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors"
						>
							<svg
								class="h-5 w-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
								></path>
							</svg>
							{t('account.orders') || 'Mes commandes'}
						</a>

						<a
							href="#settings"
							class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors"
						>
							<svg
								class="h-5 w-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
								></path>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
							</svg>
							{t('account.settings') || 'Paramètres'}
						</a>

						<button
							id="logout-btn"
							class="flex w-full items-center gap-3 rounded-lg px-4 py-3 font-medium text-red-600 transition-colors hover:bg-red-50"
						>
							<svg
								class="h-5 w-5"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
								></path>
							</svg>
							{t('account.logout') || 'Déconnexion'}
						</button>
					</nav>
				</div>
			</aside>

			<!-- Main Content -->
			<main class="space-y-8 lg:col-span-2">
				<!-- Section Profil -->
				<section
					id="profile"
					class="rounded-2xl bg-white p-8 shadow-lg"
				>
					<div class="mb-6 flex items-center justify-between">
						<h2 class="text-2xl font-bold text-[#5C3F32]">
							{
								t('account.profileTitle') ||
									'Informations personnelles'
							}
						</h2>
						<button
							id="edit-profile-btn"
							class="flex items-center gap-2 rounded-lg bg-[#5C3F32] px-4 py-2 text-white transition-colors hover:bg-[#8B4513]"
						>
							<svg
								class="h-4 w-4"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
								></path>
							</svg>
							{t('account.edit') || 'Modifier'}
						</button>
					</div>

					<form id="profile-form" class="space-y-6">
						<div class="grid grid-cols-1 gap-6 md:grid-cols-2">
							<!-- Prénom -->
							<div>
								<label
									class="mb-2 block text-sm font-medium text-[#5C3F32]"
								>
									{t('register.firstName') || 'Prénom'}
								</label>
								<input
									type="text"
									name="firstName"
									value={user.firstName}
									disabled
									class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
								/>
							</div>

							<!-- Nom -->
							<div>
								<label
									class="mb-2 block text-sm font-medium text-[#5C3F32]"
								>
									{t('register.lastName') || 'Nom'}
								</label>
								<input
									type="text"
									name="lastName"
									value={user.lastName}
									disabled
									class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
								/>
							</div>
						</div>

						<!-- Email -->
						<div>
							<label
								class="mb-2 block text-sm font-medium text-[#5C3F32]"
							>
								{t('register.email') || 'Email'}
							</label>
							<input
								type="email"
								name="email"
								value={user.email}
								disabled
								class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
							/>
						</div>

						<!-- Téléphone -->
						<div>
							<label
								class="mb-2 block text-sm font-medium text-[#5C3F32]"
							>
								{t('register.phone') || 'Téléphone'}
							</label>
							<input
								type="tel"
								name="phone"
								value={user.phone}
								disabled
								class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
							/>
						</div>

						<!-- Genre -->
						<div>
							<label
								class="mb-2 block text-sm font-medium text-[#5C3F32]"
							>
								{t('register.gender') || 'Genre'}
							</label>
							<select
								name="gender"
								disabled
								class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
							>
								<option
									value="male"
									selected={user.gender === 'male'}
								>
									{t('register.male') || 'Homme'}
								</option>
								<option
									value="female"
									selected={user.gender === 'female'}
								>
									{t('register.female') || 'Femme'}
								</option>
								<option
									value="other"
									selected={user.gender === 'other'}
								>
									{t('register.other') || 'Autre'}
								</option>
							</select>
						</div>

						<!-- Adresse -->
						<div>
							<label
								class="mb-2 block text-sm font-medium text-[#5C3F32]"
							>
								{t('account.address') || 'Adresse'}
							</label>
							<textarea
								name="address"
								disabled
								rows="3"
								class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
								>{user.address}</textarea
							>
						</div>

						<!-- Boutons de modification  -->
						<div id="edit-buttons" class="flex hidden gap-4">
							<button
								type="submit"
								class="flex-1 rounded-lg bg-[#5C3F32] px-6 py-3 font-medium text-white transition-colors hover:bg-[#8B4513]"
							>
								{t('account.save') || 'Enregistrer'}
							</button>
							<button
								type="button"
								id="cancel-edit-btn"
								class="flex-1 rounded-lg bg-gray-300 px-6 py-3 font-medium text-gray-700 transition-colors hover:bg-gray-400"
							>
								{t('account.cancel') || 'Annuler'}
							</button>
						</div>
					</form>
				</section>

				<!-- Section Commandes -->
				<section id="orders" class="rounded-2xl bg-white p-8 shadow-lg">
					<h2 class="mb-6 text-2xl font-bold text-[#5C3F32]">
						{t('account.ordersTitle') || 'Historique des commandes'}
					</h2>

					<div class="space-y-4">
						{
							orders.map((order) => (
								<div class="rounded-lg border-2 border-gray-200 p-6 transition-colors hover:border-[#5C3F32]">
									<div class="flex flex-wrap items-center justify-between gap-4">
										<div class="min-w-[200px] flex-1">
											<div class="mb-2 flex items-center gap-3">
												<span class="text-lg font-bold text-[#5C3F32]">
													{t('account.orderNumber') ||
														'Commande'}{' '}
													#{order.id}
												</span>
												<span
													class={`rounded-full px-3 py-1 text-xs font-medium ${
														order.status ===
														'delivered'
															? 'bg-green-100 text-green-700'
															: 'bg-yellow-100 text-yellow-700'
													}`}
												>
													{order.status ===
													'delivered'
														? t(
																'account.delivered',
															) || 'Livrée'
														: t(
																'account.processing',
															) || 'En cours'}
												</span>
											</div>
											<p class="text-sm text-gray-600">
												{new Date(
													order.date,
												).toLocaleDateString(lang, {
													year: 'numeric',
													month: 'long',
													day: 'numeric',
												})}
											</p>
											<p class="text-sm text-gray-600">
												{order.items}{' '}
												{t('account.items') ||
													'articles'}
											</p>
										</div>

										<div class="text-right">
											<p class="text-2xl font-bold text-[#5C3F32]">
												{order.total.toFixed(2)}€
											</p>
											<a
												href={`/${lang}/order/${order.id}`}
												class="mt-2 inline-block rounded-lg bg-[#5C3F32] px-4 py-2 text-sm text-white transition-colors hover:bg-[#8B4513]"
											>
												{t('account.viewDetails') ||
													'Voir détails'}
											</a>
										</div>
									</div>
								</div>
							))
						}
					</div>

					{
						orders.length === 0 && (
							<div class="py-12 text-center">
								<svg
									class="mx-auto mb-4 h-24 w-24 text-gray-300"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
									/>
								</svg>
								<p class="mb-4 text-lg text-gray-600">
									{t('account.noOrders') ||
										'Aucune commande pour le moment'}
								</p>
								<a
									href={`/${lang}/products`}
									class="inline-block rounded-lg bg-[#5C3F32] px-6 py-3 text-white transition-colors hover:bg-[#8B4513]"
								>
									{t('account.startShopping') ||
										'Commencer mes achats'}
								</a>
							</div>
						)
					}
				</section>

				<!-- Section Paramètres -->
				<section
					id="settings"
					class="rounded-2xl bg-white p-8 shadow-lg"
				>
					<h2 class="mb-6 text-2xl font-bold text-[#5C3F32]">
						{t('account.settingsTitle') || 'Paramètres du compte'}
					</h2>

					<div class="space-y-6">
						<!-- Changer mot de passe -->
						<div class="border-b border-gray-200 pb-6">
							<h3
								class="mb-4 text-lg font-semibold text-[#5C3F32]"
							>
								{
									t('account.changePassword') ||
										'Modifier le mot de passe'
								}
							</h3>
							<form class="space-y-4">
								<input
									type="password"
									placeholder={t('account.currentPassword') ||
										'Mot de passe actuel'}
									class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
								/>
								<input
									type="password"
									placeholder={t('account.newPassword') ||
										'Nouveau mot de passe'}
									class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
								/>
								<input
									type="password"
									placeholder={t(
										'account.confirmNewPassword',
									) || 'Confirmer le mot de passe'}
									class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
								/>
								<button
									type="submit"
									class="rounded-lg bg-[#5C3F32] px-6 py-3 text-white transition-colors hover:bg-[#8B4513]"
								>
									{
										t('account.updatePassword') ||
											'Mettre à jour'
									}
								</button>
							</form>
						</div>

						<!-- Préférences de notification -->
						<div class="border-b border-gray-200 pb-6">
							<h3
								class="mb-4 text-lg font-semibold text-[#5C3F32]"
							>
								{t('account.notifications') || 'Notifications'}
							</h3>
							<div class="space-y-3">
								<label
									class="flex cursor-pointer items-center gap-3"
								>
									<input
										type="checkbox"
										checked
										class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
									/>
									<span class="text-gray-700"
										>{
											t('account.emailNotifications') ||
												'Recevoir les notifications par email'
										}</span
									>
								</label>
								<label
									class="flex cursor-pointer items-center gap-3"
								>
									<input
										type="checkbox"
										checked
										class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
									/>
									<span class="text-gray-700"
										>{
											t('account.orderUpdates') ||
												'Mises à jour des commandes'
										}</span
									>
								</label>
								<label
									class="flex cursor-pointer items-center gap-3"
								>
									<input
										type="checkbox"
										class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
									/>
									<span class="text-gray-700"
										>{
											t('account.promotions') ||
												'Offres et promotions'
										}</span
									>
								</label>
							</div>
						</div>
					</div>
				</section>
			</main>
		</div>
	</div>

	<Footer />
</Layout>

<script lang="ts">
	// Script pour éditer le profil
	const editBtn = document.getElementById('edit-profile-btn');
	const cancelBtn = document.getElementById('cancel-edit-btn');
	const editButtons = document.getElementById('edit-buttons');
	const form = document.getElementById('profile-form');
	const inputs = form?.querySelectorAll('input, select, textarea');

	editBtn?.addEventListener('click', () => {
		inputs?.forEach((input) => {
			input.removeAttribute('disabled');
			input.classList.remove('bg-gray-50', 'disabled:cursor-not-allowed');
			input.classList.add('focus:border-[#5C3F32]', 'focus:outline-none');
		});
		editButtons?.classList.remove('hidden');
		editButtons?.classList.add('flex');
		editBtn.style.display = 'none';
	});

	cancelBtn?.addEventListener('click', () => {
		inputs?.forEach((input) => {
			input.setAttribute('disabled', 'true');
			input.classList.add('bg-gray-50', 'disabled:cursor-not-allowed');
			input.classList.remove(
				'focus:border-[#5C3F32]',
				'focus:outline-none',
			);
		});
		editButtons?.classList.add('hidden');
		editButtons?.classList.remove('flex');
		if (editBtn) editBtn.style.display = 'flex';
		form?.reset();
	});

	// ========================================
	// GESTION DE LA NAVIGATION ACTIVE
	// ========================================

	const navLinks = document.querySelectorAll('aside nav a[href^="#"]');
	const sections = document.querySelectorAll('section[id]');

	// Fonction pour mettre à jour le lien actif
	function updateActiveLink(targetId) {
		navLinks.forEach((link) => {
			const href = link.getAttribute('href')?.substring(1); // Enlever le #

			if (href === targetId) {
				// Style actif
				link.classList.remove('hover:bg-gray-100', 'text-gray-700');
				link.classList.add('bg-[#5C3F32]', 'text-white');
			} else {
				// Style inactif
				link.classList.remove('bg-[#5C3F32]', 'text-white');
				link.classList.add('hover:bg-gray-100', 'text-gray-700');
			}
		});
	}

	// Smooth scroll + mise à jour active au clic
	navLinks.forEach((anchor) => {
		anchor.addEventListener('click', function (e) {
			e.preventDefault();
			const targetId = this.getAttribute('href')?.substring(1);
			const target = document.querySelector(`#${targetId}`);

			if (target && targetId) {
				// Scroll smooth
				target.scrollIntoView({ behavior: 'smooth', block: 'start' });

				// Mettre à jour immédiatement le lien actif
				updateActiveLink(targetId);

				// Mettre à jour l'URL sans recharger
				history.pushState(null, '', `#${targetId}`);
			}
		});
	});

	// Observer pour détecter quelle section est visible
	const observerOptions = {
		root: null,
		rootMargin: '-100px 0px -66%',
		threshold: 0,
	};

	const observer = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			if (entry.isIntersecting) {
				const sectionId = entry.target.getAttribute('id');
				if (sectionId) {
					updateActiveLink(sectionId);
					history.replaceState(null, '', `#${sectionId}`);
				}
			}
		});
	}, observerOptions);

	// Observer toutes les sections
	sections.forEach((section) => observer.observe(section));

	// Activation au chargement si hash présent dans l'URL
	window.addEventListener('DOMContentLoaded', () => {
		const hash = window.location.hash.substring(1);
		if (hash) {
			updateActiveLink(hash);
			setTimeout(() => {
				const target = document.querySelector(`#${hash}`);
				target?.scrollIntoView({ behavior: 'smooth', block: 'start' });
			}, 100);
		} else {
			// Par défaut, activer "profile"
			updateActiveLink('profile');
		}
	});

	// Déconnexion
	const logoutBtn = document.getElementById('logout-btn');
	logoutBtn?.addEventListener('click', async () => {
		if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
			// Simuler la déconnexion (à remplacer par votre API)
			document.cookie =
				'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
			window.location.href = '/fr/log';
		}
	});
</script>
