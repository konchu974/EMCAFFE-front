---
import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';
import { getLangFromUrl, getStaticPaths, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export { getStaticPaths };
---

<Layout title={t('account.title') || 'Mon compte'}>
    <Header />

    <!-- Banner -->
    <section
        class="relative h-[300px] w-full overflow-hidden md:h-[400px]"
        style="margin-top: 160px; position: relative; z-index: 1;"
    >
        <img
            src="/img/PANIER.jpeg"
            alt="Account Banner"
            class="block h-[400px] w-full object-cover md:h-[500px]"
        />
        <div
            class="absolute inset-0 flex items-center justify-start bg-black/40 text-center"
        >
            <h1
                class="ml-10 font-[Chalkduster] text-4xl tracking-wide text-white md:text-7xl"
            >
                {t('account.title') || 'Mon Compte'}
            </h1>
        </div>
    </section>

    <!-- Message de chargement -->
    <div id="loading-screen" class="container mx-auto px-4 py-12 text-center">
        <div class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-solid border-[#5C3F32] border-r-transparent"></div>
        <p class="mt-4 text-lg text-gray-600">Chargement de votre profil...</p>
    </div>

    <!-- Contenu Principal (cach√© par d√©faut) -->
    <div id="account-content" class="container mx-auto px-4 py-12 hidden">
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
            <!-- Sidebar Navigation -->
            <aside class="lg:col-span-1">
                <div class="sticky top-24 rounded-2xl bg-white p-6 shadow-lg">
                    <div class="mb-6 text-center">
                        <div
                            id="user-initials"
                            class="mx-auto mb-4 flex h-24 w-24 items-center justify-center rounded-full bg-gradient-to-br from-[#5C3F32] to-[#8B4513] text-3xl font-bold text-white"
                        >
                            --
                        </div>
                        <h2 id="user-fullname" class="text-xl font-bold text-[#5C3F32]">
                            Chargement...
                        </h2>
                        <p id="user-email" class="text-sm text-gray-600">-</p>
                    </div>

                    <nav class="space-y-2">
                        <a
                            href="#profile"
                            class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors hover:bg-gray-100 text-gray-700"
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                ></path>
                            </svg>
                            {t('account.profile') || 'Mon profil'}
                        </a>

                        <a
                            href="#orders"
                            class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors hover:bg-gray-100 text-gray-700"
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                                ></path>
                            </svg>
                            {t('account.orders') || 'Mes commandes'}
                        </a>

                        <a
                            href="#settings"
                            class="nav-link flex items-center gap-3 rounded-lg px-4 py-3 font-medium transition-colors hover:bg-gray-100 text-gray-700"
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                ></path>
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            {t('account.settings') || 'Param√®tres'}
                        </a>

                        <button
                            id="logout-btn"
                            class="flex w-full items-center gap-3 rounded-lg px-4 py-3 font-medium text-red-600 transition-colors hover:bg-red-50"
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                                ></path>
                            </svg>
                            {t('account.logout') || 'D√©connexion'}
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="space-y-8 lg:col-span-2">
                <!-- Section Profil -->
                <section
                    id="profile"
                    class="rounded-2xl bg-white p-8 shadow-lg"
                >
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-[#5C3F32]">
                            {t('account.profileTitle') || 'Informations personnelles'}
                        </h2>
                        <button
                            id="edit-profile-btn"
                            class="flex items-center gap-2 rounded-lg bg-[#5C3F32] px-4 py-2 text-white transition-colors hover:bg-[#8B4513]"
                        >
                            <svg
                                class="h-4 w-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                ></path>
                            </svg>
                            {t('account.edit') || 'Modifier'}
                        </button>
                    </div>

                    <form id="profile-form" class="space-y-6">
                        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                            <!-- Pr√©nom -->
                            <div>
                                <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                    {t('register.firstName') || 'Pr√©nom'}
                                </label>
                                <input
                                    type="text"
                                    name="firstName"
                                    disabled
                                    class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                                />
                            </div>

                            <!-- Nom -->
                            <div>
                                <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                    {t('register.lastName') || 'Nom'}
                                </label>
                                <input
                                    type="text"
                                    name="lastName"
                                    disabled
                                    class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                                />
                            </div>
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                {t('register.email') || 'Email'}
                            </label>
                            <input
                                type="email"
                                name="email"
                                disabled
                                class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                            />
                        </div>

                        <!-- T√©l√©phone -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                {t('register.phone') || 'T√©l√©phone'}
                            </label>
                            <input
                                type="tel"
                                name="phone"
                                disabled
                                class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                            />
                        </div>

                        <!-- Genre -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                {t('register.gender') || 'Genre'}
                            </label>
                            <select
                                name="gender"
                                disabled
                                class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                            >
                                <option value="">S√©lectionner...</option>
                                <option value="M">{t('register.male') || 'Homme'}</option>
                                <option value="F">{t('register.female') || 'Femme'}</option>
                                <option value="OTHER">{t('register.other') || 'Autre'}</option>
                            </select>
                        </div>


                        <!-- Adresse -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-[#5C3F32]">
                                {t('account.address') || 'Adresse'}
                            </label>
                            <textarea
                                name="address"
                                disabled
                                rows="3"
                                class="w-full rounded-lg border-2 border-gray-300 bg-gray-50 px-4 py-3 disabled:cursor-not-allowed"
                            ></textarea>
                        </div>

                        <!-- Boutons de modification (cach√©s par d√©faut) -->
                        <div id="edit-buttons" class="flex hidden gap-4">
                            <button
                                type="submit"
                                class="flex-1 rounded-lg bg-[#5C3F32] px-6 py-3 font-medium text-white transition-colors hover:bg-[#8B4513]"
                            >
                                {t('account.save') || 'Enregistrer'}
                            </button>
                            <button
                                type="button"
                                id="cancel-edit-btn"
                                class="flex-1 rounded-lg bg-gray-300 px-6 py-3 font-medium text-gray-700 transition-colors hover:bg-gray-400"
                            >
                                {t('account.cancel') || 'Annuler'}
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Section Commandes -->
                <section id="orders" class="rounded-2xl bg-white p-8 shadow-lg">
                    <h2 class="mb-6 text-2xl font-bold text-[#5C3F32]">
                        {t('account.ordersTitle') || 'Historique des commandes'}
                    </h2>

                    <div id="orders-list" class="space-y-4">
                        <!-- Les commandes seront charg√©es ici dynamiquement -->
                    </div>

                    <div id="no-orders" class="py-12 text-center hidden">
                        <svg
                            class="mx-auto mb-4 h-24 w-24 text-gray-300"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                            />
                        </svg>
                        <p class="mb-4 text-lg text-gray-600">
                            {t('account.noOrders') || 'Aucune commande pour le moment'}
                        </p>
                        <a
                            href={`/${lang}/products`}
                            class="inline-block rounded-lg bg-[#5C3F32] px-6 py-3 text-white transition-colors hover:bg-[#8B4513]"
                        >
                            {t('account.startShopping') || 'Commencer mes achats'}
                        </a>
                    </div>
                </section>

                <!-- Section Param√®tres -->
                <section id="settings" class="rounded-2xl bg-white p-8 shadow-lg">
                    <h2 class="mb-6 text-2xl font-bold text-[#5C3F32]">
                        {t('account.settingsTitle') || 'Param√®tres du compte'}
                    </h2>

                    <div class="space-y-6">
                        <!-- Changer mot de passe -->
                        <div class="border-b border-gray-200 pb-6">
                            <h3 class="mb-4 text-lg font-semibold text-[#5C3F32]">
                                {t('account.changePassword') || 'Modifier le mot de passe'}
                            </h3>
                            <form id="password-form" class="space-y-4">
                                <input
                                    type="password"
                                    name="currentPassword"
                                    placeholder={t('account.currentPassword') || 'Mot de passe actuel'}
                                    class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
                                />
                                <input
                                    type="password"
                                    name="newPassword"
                                    placeholder={t('account.newPassword') || 'Nouveau mot de passe'}
                                    class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
                                />
                                <input
                                    type="password"
                                    name="confirmPassword"
                                    placeholder={t('account.confirmNewPassword') || 'Confirmer le mot de passe'}
                                    class="w-full rounded-lg border-2 border-gray-300 px-4 py-3"
                                />
                                <button
                                    type="submit"
                                    class="rounded-lg bg-[#5C3F32] px-6 py-3 text-white transition-colors hover:bg-[#8B4513]"
                                >
                                    {t('account.updatePassword') || 'Mettre √† jour'}
                                </button>
                            </form>
                        </div>

                        <!-- Pr√©f√©rences de notification -->
                        <div class="border-b border-gray-200 pb-6">
                            <h3 class="mb-4 text-lg font-semibold text-[#5C3F32]">
                                {t('account.notifications') || 'Notifications'}
                            </h3>
                            <div class="space-y-3">
                                <label class="flex cursor-pointer items-center gap-3">
                                    <input
                                        type="checkbox"
                                        checked
                                        class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
                                    />
                                    <span class="text-gray-700">
                                        {t('account.emailNotifications') || 'Recevoir les notifications par email'}
                                    </span>
                                </label>
                                <label class="flex cursor-pointer items-center gap-3">
                                    <input
                                        type="checkbox"
                                        checked
                                        class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
                                    />
                                    <span class="text-gray-700">
                                        {t('account.orderUpdates') || 'Mises √† jour des commandes'}
                                    </span>
                                </label>
                                <label class="flex cursor-pointer items-center gap-3">
                                    <input
                                        type="checkbox"
                                        class="h-5 w-5 rounded border-gray-300 text-[#5C3F32]"
                                    />
                                    <span class="text-gray-700">
                                        {t('account.promotions') || 'Offres et promotions'}
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <Footer />
</Layout>

<script>
  import { userService } from '@/lib/api/userService';
  
  const lang = document.documentElement.lang || 'fr';
  
  function hideLoadingScreen() {
    console.log('üîÑ Masquage du loading screen...');
    const loadingScreen = document.getElementById('loading-screen');
    const accountContent = document.getElementById('account-content');
    
    if (loadingScreen) {
      loadingScreen.classList.add('hidden');
      console.log('‚úÖ Loading screen masqu√©');
    }
    
    if (accountContent) {
      accountContent.classList.remove('hidden');
      console.log('‚úÖ Contenu affich√©');
    }
  }
  
  function showError(message: string) {
    console.log('‚ùå Affichage erreur:', message);
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
      loadingScreen.innerHTML = `
        <div class="text-center">
          <svg class="mx-auto mb-4 h-16 w-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-red-600 text-lg font-semibold mb-4">${message}</p>
          <a href="/${lang}/log" class="inline-block rounded-lg bg-[#5C3F32] px-6 py-3 text-white hover:bg-[#8B4513] transition-colors">
            Retour √† la connexion
          </a>
        </div>
      `;
    }
  }
    
  function updateUserInterface(user: any) {
    
    const initialsEl = document.getElementById('user-initials');
    if (initialsEl && user.first_name && user.last_name) {
      const initials = `${user.first_name.charAt(0)}${user.last_name.charAt(0)}`.toUpperCase();
      initialsEl.textContent = initials;
      console.log('‚úÖ Initiales:', initials);
    }
    
    const fullnameEl = document.getElementById('user-fullname');
    if (fullnameEl) {
      fullnameEl.textContent = `${user.first_name} ${user.last_name}`;
      console.log('‚úÖ Nom complet affich√©');
    }
    
    const emailEl = document.getElementById('user-email');
    if (emailEl) {
      emailEl.textContent = user.email;
      console.log('‚úÖ Email affich√©');
    }
    
    const form = document.getElementById('profile-form') as HTMLFormElement;
    if (form) {
      const firstNameInput = form.querySelector('[name="firstName"]') as HTMLInputElement;
      const lastNameInput = form.querySelector('[name="lastName"]') as HTMLInputElement;
      const emailInput = form.querySelector('[name="email"]') as HTMLInputElement;
      const phoneInput = form.querySelector('[name="phone"]') as HTMLInputElement;
      const addressInput = form.querySelector('[name="address"]') as HTMLTextAreaElement;
      const genderInput = form.querySelector('[name="gender"]') as HTMLSelectElement;
      
      if (firstNameInput) {
        firstNameInput.value = user.first_name || '';
        console.log('‚úÖ Pr√©nom rempli:', user.first_name);
      }
      if (lastNameInput) {
        lastNameInput.value = user.last_name || '';
        console.log('‚úÖ Nom rempli:', user.last_name);
      }
      if (emailInput) {
        emailInput.value = user.email || '';
        console.log('‚úÖ Email rempli:', user.email);
      }
      if (phoneInput) {
        phoneInput.value = user.phone || '';
        console.log('‚úÖ T√©l√©phone rempli:', user.phone);
      }
      if (addressInput) {
        addressInput.value = user.address || '';
        console.log('‚úÖ Adresse remplie:', user.address);
      }
      if (genderInput && user.gender) {
        genderInput.value = user.gender;
        console.log('‚úÖ Genre rempli:', user.gender);
      }
    }
    
    console.log('‚úÖ Interface mise √† jour');
  }
  
  async function initAccount() {
    
    // V√©rifier l'authentification
    const isAuth = userService.isAuthenticated();
    console.log('Authentifi√©:', isAuth);
    
    if (!isAuth) {
      console.log('Non authentifi√©, redirection...');
      showError('Vous devez √™tre connect√© pour acc√©der √† cette page');
      setTimeout(() => {
        window.location.href = `/${lang}/log`;
      }, 2000);
      return;
    }

    try {
      const user = await userService.getProfile();
      console.log('‚úÖ Profil re√ßu:', user);
      
      // Mettre √† jour l'interface
      updateUserInterface(user);
      
      // Masquer le loading et afficher le contenu
      hideLoadingScreen();
      
    } catch (error) {
      console.error('Erreur lors du chargement:', error);
      
      if (error instanceof Error && (error.message.includes('401') || error.message.includes('Session'))) {
        console.log('Token invalide, d√©connexion...');
        userService.logout();
        showError('Votre session a expir√©');
        setTimeout(() => {
          window.location.href = `/${lang}/log`;
        }, 2000);
      } else {
        showError('Erreur lors du chargement de votre profil');
      }
    }
  }
  
  function setupProfileEditing() {
    const profileForm = document.getElementById('profile-form') as HTMLFormElement;
    const editBtn = document.getElementById('edit-profile-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const editButtons = document.getElementById('edit-buttons');
    
    if (!profileForm || !editBtn) return;
    
    // Bouton "Modifier"
    editBtn.addEventListener('click', () => {
      
      // Activer tous les champs
      const inputs = profileForm.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        (input as HTMLInputElement).disabled = false;
        input.classList.remove('bg-gray-50', 'cursor-not-allowed');
        input.classList.add('bg-white');
      });
      
      // Afficher les boutons de sauvegarde
      editButtons?.classList.remove('hidden');
      editBtn.classList.add('hidden');
    });
    
    // Bouton "Annuler"
    cancelBtn?.addEventListener('click', () => {
      
      // D√©sactiver tous les champs
      const inputs = profileForm.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        (input as HTMLInputElement).disabled = true;
        input.classList.add('bg-gray-50', 'cursor-not-allowed');
        input.classList.remove('bg-white');
      });
      
      // Restaurer les valeurs d'origine
      const user = userService.getCurrentUser();
      if (user) {
        updateUserInterface(user);
      }
      
      // Masquer les boutons de sauvegarde
      editButtons?.classList.add('hidden');
      editBtn.classList.remove('hidden');
    });
    
    // Soumission du formulaire
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Sauvegarde du profil...');
      
      const user = userService.getCurrentUser();
      if (!user) {
        alert('Session expir√©e');
        window.location.href = `/${lang}/log`;
        return;
      }

      const userId = user.id_user_account || user.id;
      
      const formData = new FormData(profileForm);
      const updateData = {
        first_name: formData.get('firstName') as string,
        last_name: formData.get('lastName') as string,
        email: formData.get('email') as string,
        phone: formData.get('phone') as string,
        address: formData.get('address') as string,
        gender: formData.get('gender') as string,
      };

      try {
        console.log('üì§ Donn√©es √† envoyer:', updateData);
        const updatedUser = await userService.updateProfile(userId, updateData);
        console.log('‚úÖ Profil mis √† jour:', updatedUser);
        
        // Mettre √† jour l'interface
        updateUserInterface(updatedUser);
        
        // D√©sactiver les champs
        const inputs = profileForm.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          (input as HTMLInputElement).disabled = true;
          input.classList.add('bg-gray-50', 'cursor-not-allowed');
          input.classList.remove('bg-white');
        });
        
        // Masquer les boutons de sauvegarde
        editButtons?.classList.add('hidden');
        editBtn.classList.remove('hidden');
        
        alert('‚úÖ Profil mis √† jour avec succ√®s !');
      } catch (error) {
        console.error('‚ùå Erreur mise √† jour:', error);
        alert(error instanceof Error ? error.message : 'Erreur lors de la mise √† jour');
      }
    });
  }
  
  
  function setupLogout() {
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn?.addEventListener('click', () => {
      console.log(' D√©connexion...');
      
      if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        userService.logout();
        window.location.href = `/${lang}/log`;
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('‚úÖ DOM charg√©, d√©marrage...');
    initAccount();
    setupProfileEditing();
    setupLogout();
  });
</script>


<style>
    /* Animation de chargement */
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Am√©lioration du focus */
    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(92, 63, 50, 0.1);
    }
</style>
