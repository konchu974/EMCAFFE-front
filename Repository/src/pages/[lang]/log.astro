---
import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';

import { getLangFromUrl, getStaticPaths, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export { getStaticPaths };
---

<Layout title={`EMCAFFE - ${t("login.title")|| 'Connexion'} `}>
    <Header />
    
 <!-- Banner -->
   <section class="relative h-[300px] md:h-[400px] w-full overflow-hidden" style="margin-top: 160px; position: relative; z-index: 1;">
    <img src="/img/PANIER.jpeg" alt="Coffee Banner" class="w-full h-[400px] md:h-[500px] object-cover block">
    <div class="absolute inset-0 flex items-center justify-start text-center bg-black/40 ">
      <h1 class="text-white text-4xl md:text-7xl font-[Chalkduster] tracking-wide ml-10 ">
        {t('login.title')}
      </h1>
    </div>
   </section>
   <!-- Banner -->
   
   <div class="flex items-center justify-center px-4 mt-10 pb-12 relative z-10">
        <div class="w-full max-w-md rounded-2xl bg-white p-8 shadow-2xl">
            <!-- Titre -->
            <h1 class="mb-2 text-center text-3xl font-bold text-[#5C3F32]">
                {t('login.welcome') || 'Bienvenue'}
            </h1>
            <p class="mb-8 text-center text-gray-600">
                {t('login.subtitle') || 'Connectez-vous √† votre compte'}
            </p>

            <!-- Message d'erreur -->
            <div id="errorMessage" class="mb-4 hidden rounded-lg bg-red-50 border border-red-200 p-4 text-red-800"></div>
            
            <!-- Message de succ√®s -->
            <div id="successMessage" class="mb-4 hidden rounded-lg bg-green-50 border border-green-200 p-4 text-green-800"></div>

            <!-- Formulaire de connexion -->
            <form id="loginForm" class="space-y-6">
                <!-- Email -->
                <div>
                    <label
                        for="email"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('login.email') || 'Email'}
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        placeholder="exemple@email.com"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                </div>

                <!-- Mot de passe -->
                <div>
                    <label
                        for="password"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('login.password') || 'Mot de passe'}
                    </label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                </div>

                <!-- Se souvenir de moi & Mot de passe oubli√© -->
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input
                            type="checkbox"
                            id="remember"
                            name="remember"
                            class="h-4 w-4 rounded border-gray-300 text-[#5C3F32] focus:ring-[#5C3F32]"
                        />
                        <span class="ml-2 text-sm text-gray-600">
                            {t('login.remember') || 'Se souvenir de moi'}
                        </span>
                    </label>
                    <a
                        href={`/${lang}/forgot-password`}
                        class="text-sm text-[#5C3F32] hover:text-[#8B4513] hover:underline"
                    >
                        {t('login.forgot') || 'Mot de passe oubli√© ?'}
                    </a>
                </div>

                <!-- Bouton de connexion -->
                <button
                    type="submit"
                    id="submitBtn"
                    class="w-full transform rounded-lg bg-[#5C3F32] px-6 py-3 font-bold text-white transition duration-300 hover:scale-105 hover:bg-[#8B4513] disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span id="btnText">{t('login.submit') || 'Se connecter'}</span>
                    <span id="btnLoader" class="hidden">
                        <svg class="animate-spin inline-block h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Connexion...
                    </span>
                </button>
            </form>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-4 text-gray-500">
                        {t('login.or') || 'ou'}
                    </span>
                </div>
            </div>

            <!-- Lien d'inscription -->
            <div class="text-center">
                <p class="mb-4 text-gray-600">
                    {t('login.noAccount') || "Vous n'avez pas de compte ?"}
                </p>
                <a
                    href={`/${lang}/register`}
                    class="inline-block w-full rounded-lg border-2 border-[#5C3F32] bg-white px-6 py-3 text-center font-bold text-[#5C3F32] transition duration-300 hover:bg-[#5C3F32] hover:text-white"
                >
                    {t('login.register') || 'Cr√©er un compte'}
                </a>
            </div>
        </div>
    </div>

    <Footer />
</Layout>

<script>
    import { userService } from '@/lib/api/userService';

    const form = document.getElementById('loginForm') as HTMLFormElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const rememberCheckbox = document.getElementById('remember') as HTMLInputElement;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const btnText = document.getElementById('btnText');
    const btnLoader = document.getElementById('btnLoader');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // R√©cup√©rer la langue depuis l'URL
    const lang = window.location.pathname.split('/')[1] || 'fr';

    // V√©rifier si l'utilisateur est d√©j√† connect√©
    async function checkAuth() {
        if (userService.isAuthenticated()) {
            try {
                const user = await userService.getProfile();
                // Rediriger sans hash
                window.location.replace(`/${lang}/account`);
            } catch (error) {
                // Token invalide, nettoyer
                console.log('Token invalide, nettoyage...');
                userService.logout();
            }
        }
    }

    // V√©rifier l'authentification au chargement
    checkAuth();

    // Fonction pour afficher les erreurs
    function showError(message: string) {
        if (errorMessage) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        if (successMessage) {
            successMessage.classList.add('hidden');
        }
    }

    // Fonction pour afficher le succ√®s
    function showSuccess(message: string) {
        if (successMessage) {
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
        }
        if (errorMessage) {
            errorMessage.classList.add('hidden');
        }
    }

    // Fonction pour g√©rer l'√©tat de chargement
    function setLoading(isLoading: boolean) {
        if (submitBtn) {
            submitBtn.disabled = isLoading;
        }
        if (btnText && btnLoader) {
            if (isLoading) {
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }
    }

    // Gestion de la soumission du formulaire
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // R√©initialiser les messages
        if (errorMessage) errorMessage.classList.add('hidden');
        if (successMessage) successMessage.classList.add('hidden');

        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(form);
        const data = {
            email: formData.get('email') as string,
            password: formData.get('password') as string,
        };

        // Validation basique
        if (!data.email || !data.password) {
            showError('Veuillez remplir tous les champs');
            return;
        }

        // Activer l'√©tat de chargement
        setLoading(true);

        try {
            console.log('üîÑ Tentative de connexion...');
            
            // Appeler l'API
            const result = await userService.login(data);
            console.log('‚úÖ Connexion r√©ussie:', result);

            // G√©rer "Se souvenir de moi"
            if (rememberCheckbox?.checked) {
                localStorage.setItem('rememberMe', 'true');
                localStorage.setItem('savedEmail', data.email);
            } else {
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('savedEmail');
            }

            // Afficher le message de succ√®s
            showSuccess('Connexion r√©ussie ! Redirection...');

            setTimeout(() => {
                if (result.user?.role === 'ADMIN') {
                    console.log('üë§ Redirection admin...');
                    window.location.replace(`/${lang}/admin/account`);
                } else {
                    console.log('üë§ Redirection client...');
                    window.location.replace(`/${lang}/account`);
                }
            }, 1000);

        } catch (error) {
            console.error('‚ùå Erreur de connexion:', error);
            const errorMsg = error instanceof Error ? error.message : 'Erreur lors de la connexion';
            showError(errorMsg);
            setLoading(false);
        }
    });

    // Pr√©-remplir l'email si "Se souvenir de moi" √©tait activ√©
    const rememberMe = localStorage.getItem('rememberMe');
    const savedEmail = localStorage.getItem('savedEmail');
    if (rememberMe === 'true' && savedEmail && emailInput) {
        emailInput.value = savedEmail;
        if (rememberCheckbox) {
            rememberCheckbox.checked = true;
        }
    }

    // Sauvegarder l'email lors de la saisie
    emailInput?.addEventListener('change', () => {
        if (rememberCheckbox?.checked) {
            localStorage.setItem('savedEmail', emailInput.value);
        }
    });
</script>


<style>
    /* Animation pour le loader */
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Am√©lioration du focus pour l'accessibilit√© */
    input:focus {
        box-shadow: 0 0 0 3px rgba(92, 63, 50, 0.1);
    }

    /* Animation pour les messages */
    #errorMessage, #successMessage {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
              