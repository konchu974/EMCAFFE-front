---
import Footer from '@/components/Footer.astro';
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';

import { getLangFromUrl, getStaticPaths, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export { getStaticPaths };
---

<Layout title={t('register.title') || 'Inscription'}>
    <Header />

    <!-- Banner -->
    <section
        class="relative h-[300px] w-full overflow-hidden md:h-[400px]"
        style="margin-top: 160px; position: relative; z-index: 1;"
    >
           <img src="/img/connexion.jpeg" alt="Coffee Banner" class="w-full h-[400px] md:h-[400px] object-cover block">

        <div
            class="absolute inset-0 flex items-center justify-start bg-black/40 text-center"
        >
            <h1
                class="ml-10 font-[Chalkduster] text-4xl tracking-wide text-white md:text-7xl"
            >
                {t('register.title')}
            </h1>
        </div>
    </section>

    <div
        class="relative z-10 mt-10 flex items-center justify-center px-4 pb-12"
    >
        <div class="w-full max-w-md rounded-2xl bg-white p-8 shadow-2xl">
            <!-- Titre -->
            <h1 class="mb-2 text-center text-3xl font-bold text-[#5C3F32]">
                {t('register.welcome') || 'Cr√©er un compte'}
            </h1>
            <p class="mb-8 text-center text-gray-600">
                {t('register.subtitle') || 'Rejoignez-nous d√®s maintenant'}
            </p>

            <!-- Formulaire d'inscription -->
            <form
                id="register-form"
                class="space-y-5"
            >
                <!-- Pr√©nom et Nom -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Pr√©nom -->
                    <div>
                        <label
                            for="firstName"
                            class="mb-2 block text-sm font-medium text-[#5C3F32]"
                        >
                            {t('register.firstName') || 'Pr√©nom'}
                        </label>
                        <input
                            type="text"
                            id="firstName"
                            name="firstName"
                            required
                            placeholder="Jean"
                            class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                        />
                    </div>

                    <!-- Nom -->
                    <div>
                        <label
                            for="lastName"
                            class="mb-2 block text-sm font-medium text-[#5C3F32]"
                        >
                            {t('register.lastName') || 'Nom'}
                        </label>
                        <input
                            type="text"
                            id="lastName"
                            name="lastName"
                            required
                            placeholder="Dupont"
                            class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                        />
                    </div>
                </div>

                <!-- Genre -->
                <div>
                    <label
                        for="gender"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('register.gender') || 'Genre'}
                    </label>
                    <select
                        id="gender"
                        name="gender"
                        required
                        class="w-full rounded-lg border-2 border-gray-300 bg-white px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    >
                        <option value="" disabled selected>
                            {
                                t('register.selectGender') ||
                                    'S√©lectionnez votre genre'
                            }
                        </option>
                        <option value="M">
                            {t('register.male') || 'Homme'}
                        </option>
                        <option value="F">
                            {t('register.female') || 'Femme'}
                        </option>
                        <option value="OTHER">
                            {t('register.other') || 'Autre'}
                        </option>
                    </select>
                </div>


                <!-- Email -->
                <div>
                    <label
                        for="email"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('register.email') || 'Email'}
                    </label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        placeholder="exemple@email.com"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                </div>

                <!-- T√©l√©phone -->
                <div>
                    <label
                        for="phone"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('register.phone') || 'T√©l√©phone'}
                    </label>
                    <input
                        type="tel"
                        id="phone"
                        name="phone"
                        placeholder="+33 6 12 34 56 78"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                </div>

                <!-- Mot de passe -->
                <div>
                    <label
                        for="password"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {t('register.password') || 'Mot de passe'}
                    </label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        minlength="8"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                    <p class="mt-1 text-xs text-gray-500">
                        {t('register.passwordHint') || 'Minimum 8 caract√®res'}
                    </p>
                </div>

                <!-- Confirmer mot de passe -->
                <div>
                    <label
                        for="confirmPassword"
                        class="mb-2 block text-sm font-medium text-[#5C3F32]"
                    >
                        {
                            t('register.confirmPassword') ||
                                'Confirmer le mot de passe'
                        }
                    </label>
                    <input
                        type="password"
                        id="confirmPassword"
                        name="confirmPassword"
                        required
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        minlength="8"
                        class="w-full rounded-lg border-2 border-gray-300 px-4 py-3 transition duration-300 focus:border-[#5C3F32] focus:outline-none"
                    />
                </div>

                <!-- Conditions d'utilisation -->
                <div class="flex items-start">
                    <input
                        type="checkbox"
                        id="terms"
                        name="terms"
                        required
                        class="mt-1 h-4 w-4 rounded border-gray-300 text-[#5C3F32] focus:ring-[#5C3F32]"
                    />
                    <label for="terms" class="ml-2 text-sm text-gray-600">
                        <span class="text-red-500">*</span>
                        {t('register.terms') || "J'accepte les"}
                        <a
                            href={`/${lang}/terms`}
                            class="text-[#5C3F32] hover:underline"
                        >
                            {
                                t('register.termsLink') ||
                                    "conditions d'utilisation"
                            }
                        </a>
                    </label>
                </div>

                <!-- Politique de confidentialit√© -->
                <div class="flex items-start">
                    <input
                        type="checkbox"
                        id="privacy"
                        name="privacy"
                        required
                        class="mt-1 h-4 w-4 rounded border-gray-300 text-[#5C3F32] focus:ring-[#5C3F32]"
                    />
                    <label for="privacy" class="ml-2 text-sm text-gray-600">
                        <span class="text-red-500">*</span>
                        {
                            t('register.privacyAccept') ||
                                "J'accepte la"
                        }
                        <a
                            href={`/${lang}/privacy`}
                            class="text-[#5C3F32] hover:underline"
                        >
                            {
                                t('register.privacyLink') ||
                                    'politique de confidentialit√©'
                            }
                        </a>
                    </label>
                </div>

                <!-- Newsletter -->
                <div class="flex items-start">
                    <input
                        type="checkbox"
                        id="newsletter"
                        name="newsletter"
                        class="mt-1 h-4 w-4 rounded border-gray-300 text-[#5C3F32] focus:ring-[#5C3F32]"
                    />
                    <label for="newsletter" class="ml-2 text-sm text-gray-600">
                        {
                            t('register.newsletter') ||
                                "Je souhaite recevoir la newsletter et les offres promotionnelles"
                        }
                    </label>
                </div>

                <!-- Message d'erreur -->
                <div
                    id="error-message"
                    class="hidden rounded-lg bg-red-100 p-3 text-sm text-red-700"
                >
                </div>

                <!-- Message de succ√®s -->
                <div
                    id="success-message"
                    class="hidden rounded-lg bg-green-100 p-3 text-sm text-green-700"
                >
                </div>

                <!-- Bouton d'inscription -->
                <button
                    type="submit"
                    id="submit-btn"
                    class="w-full transform rounded-lg bg-[#5C3F32] px-6 py-3 font-bold text-white transition duration-300 hover:scale-105 hover:bg-[#8B4513] disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    {t('register.submit') || 'Cr√©er mon compte'}
                </button>
            </form>

            <!-- Divider -->
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-white px-4 text-gray-500">
                        {t('register.or') || 'ou'}
                    </span>
                </div>
            </div>

            <!-- Lien de connexion -->
            <div class="text-center">
                <p class="mb-4 text-gray-600">
                    {t('register.hasAccount') || 'Vous avez d√©j√† un compte ?'}
                </p>
                <a
                    href={`/${lang}/log`}
                    class="inline-block w-full rounded-lg border-2 border-[#5C3F32] bg-white px-6 py-3 text-center font-bold text-[#5C3F32] transition duration-300 hover:bg-[#5C3F32] hover:text-white"
                >
                    {t('register.login') || 'Se connecter'}
                </a>
            </div>
        </div>
    </div>

    <Footer />
</Layout>

<script>
  import type { Gender } from '@/lib/api/types/user.types';
import { userService } from '@/lib/api/userService';
  
  const lang = document.documentElement.lang || 'fr';
  
  // ============================================
  // GESTION DES MESSAGES
  // ============================================
  
  function showError(message: string) {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
    if (successDiv) {
      successDiv.classList.add('hidden');
    }
    
    // Scroll vers le message
    errorDiv?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  
  function showSuccess(message: string) {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    if (successDiv) {
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
    }
    if (errorDiv) {
      errorDiv.classList.add('hidden');
    }
    
    // Scroll vers le message
    successDiv?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  
  function hideMessages() {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    errorDiv?.classList.add('hidden');
    successDiv?.classList.add('hidden');
  }
  
  // ============================================
  // VALIDATION DU FORMULAIRE
  // ============================================
  
  function validatePassword(password: string, confirmPassword: string): string | null {
    if (password.length < 8) {
      return 'Le mot de passe doit contenir au moins 8 caract√®res';
    }
    
    if (password !== confirmPassword) {
      return 'Les mots de passe ne correspondent pas';
    }
    
    // V√©rification de la complexit√© (optionnel)
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    
    if (!hasUpperCase || !hasLowerCase || !hasNumber) {
      return 'Le mot de passe doit contenir au moins une majuscule, une minuscule et un chiffre';
    }
    
    return null;
  }
  
  function validateEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
  
  function validatePhone(phone: string): boolean {
  if (!phone) return true;

  // Enl√®ve tous les caract√®res inutiles
  const cleaned = phone.replace(/[\s.-]/g, '');

  // 06XXXXXXXX
  if (/^0[1-9]\d{8}$/.test(cleaned)) return true;

  // +336XXXXXXXX ou +337XXXXXXXX
  if (/^\+33[1-9]\d{8}$/.test(cleaned)) return true;

  // 00336XXXXXXXX
  if (/^0033[1-9]\d{8}$/.test(cleaned)) return true;

  return false;
}
  
  // ============================================
  // SOUMISSION DU FORMULAIRE
  // ============================================
  
  async function handleRegister(event: Event) {
    event.preventDefault();
    
    console.log('üìù D√©but de l\'inscription...');
    hideMessages();
    
    const form = event.target as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const formData = new FormData(form);
    
    // R√©cup√©ration des donn√©es
    const firstName = (formData.get('firstName') as string).trim();
    const lastName = (formData.get('lastName') as string).trim();
    const gender = formData.get('gender') as Gender;
    const email = (formData.get('email') as string).trim();
    const phone = (formData.get('phone') as string).trim();
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirmPassword') as string;
    const termsAccepted = formData.get('terms') === 'on';
    const privacyAccepted = formData.get('privacy') === 'on';
    const newsletter = formData.get('newsletter') === 'on';
    
    // Validations c√¥t√© client
    if (!firstName || !lastName) {
      showError('Veuillez renseigner votre nom et pr√©nom');
      return;
    }
    
    if (!gender || !['M', 'F', 'OTHER'].includes(gender)) {
      showError('Veuillez s√©lectionner un genre valide');
      return;
    }
    
    if (!validateEmail(email)) {
      showError('Veuillez entrer une adresse email valide');
      return;
    }
    
    if (!validatePhone(phone)) {
      showError('Le num√©ro de t√©l√©phone n\'est pas valide');
      return;
    }
    
    const passwordError = validatePassword(password, confirmPassword);
    if (passwordError) {
      showError(passwordError);
      return;
    }
    
    if (!termsAccepted || !privacyAccepted) {
      showError('Vous devez accepter les conditions d\'utilisation et la politique de confidentialit√©');
      return;
    }
    
    // D√©sactiver le bouton
    submitBtn.disabled = true;
    submitBtn.textContent = 'Cr√©ation du compte...';
    
    try {
      console.log('üì§ Envoi des donn√©es √† l\'API...');
      
      const registerData = {
        first_name: firstName,
        last_name: lastName,
        gender: gender, // ‚úÖ Sera M, F ou OTHER
        email: email,
        phone: phone || undefined,
        password: password,
        newsletter: newsletter
      };
      
      console.log('üì¶ Donn√©es √† envoyer:', registerData);
      
      // Appel √† l'API
      const result = await userService.register(registerData);
      
      console.log('‚úÖ Inscription r√©ussie:', result);
      
      showSuccess('‚úÖ Compte cr√©√© avec succ√®s ! Redirection vers la connexion...');
      
      // R√©initialiser le formulaire
      form.reset();
      
      // Redirection apr√®s 2 secondes
      setTimeout(() => {
        window.location.href = `/${lang}/log?registered=true`;
      }, 2000);
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'inscription:', error);
      
      if (error instanceof Error) {
        // Am√©liorer le message d'erreur
        let errorMessage = error.message;
        
        if (errorMessage.includes('gender')) {
          errorMessage = 'Genre invalide. Veuillez s√©lectionner Homme, Femme ou Autre.';
        } else if (errorMessage.includes('email')) {
          errorMessage = 'Cet email est d√©j√† utilis√© ou invalide.';
        } else if (errorMessage.includes('password')) {
          errorMessage = 'Le mot de passe ne respecte pas les crit√®res de s√©curit√©.';
        }
        
        showError(errorMessage);
      } else {
        showError('Une erreur est survenue lors de la cr√©ation du compte');
      }
      
      // R√©activer le bouton
      submitBtn.disabled = false;
      submitBtn.textContent = 'Cr√©er mon compte';
    }
  }

  
  // ============================================
  // INITIALISATION
  // ============================================
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('‚úÖ Page d\'inscription charg√©e');
    
    // V√©rifier si d√©j√† connect√©
    if (userService.isAuthenticated()) {
      console.log('üîê D√©j√† authentifi√©, redirection...');
      window.location.href = `/${lang}/account`;
      return;
    }
    
    // Attacher le gestionnaire de soumission
    const form = document.getElementById('register-form');
    if (form) {
      form.addEventListener('submit', handleRegister);
      console.log('‚úÖ Gestionnaire de formulaire attach√©');
    }

    // Emp√™cher les espaces dans le num√©ro
const phoneInput = document.getElementById('phone') as HTMLInputElement;

if (phoneInput) {
  // Bloque la touche espace au clavier
  phoneInput.addEventListener('keydown', (e) => {
    if (e.key === " ") e.preventDefault();
  });

  // Nettoie les espaces si coll√©s via copier/coller
  phoneInput.addEventListener('input', (e) => {
    phoneInput.value = phoneInput.value.replace(/\s+/g, '');
  });
}

    
    // Validation en temps r√©el du mot de passe
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
    
    if (confirmPasswordInput) {
      confirmPasswordInput.addEventListener('input', () => {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword && password !== confirmPassword) {
          confirmPasswordInput.setCustomValidity('Les mots de passe ne correspondent pas');
        } else {
          confirmPasswordInput.setCustomValidity('');
        }
      });
    }
  });
</script>

<style>
    /* Animation de chargement */
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    /* Am√©lioration du focus */
    input:focus,
    select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(92, 63, 50, 0.1);
    }
    
    /* √âtat invalide */
    input:invalid:not(:placeholder-shown) {
        border-color: #EF4444;
    }
    
    /* √âtat valide */
    input:valid:not(:placeholder-shown) {
        border-color: #10B981;
    }
</style>