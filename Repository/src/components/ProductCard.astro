---
const {
  img,
  productName,
  id,
  description,
  ingredient,
  preparation,
  dimension,
  tabTitles,
  t,
  variants = [],
} = Astro.props;

function formatTextWithLineBreaks(text: string): string[] {
  return text?.split('\n') ?? [];
}
---

<div class="m-5 -mt-24 md:m-10 md:mt-0">
  <h2 class="mb-8 text-center text-2xl font-bold text-[#5C3F32] sm:text-3xl lg:text-4xl">
    {productName}
  </h2>

  <div class="flex flex-col lg:flex-row lg:items-start lg:gap-8">
    <!-- COLONNE GAUCHE - Images -->
    <div class="flex flex-col items-center lg:sticky lg:top-24 lg:w-1/2 lg:self-start">
      <div class="mb-6 w-full max-w-2xl lg:max-w-none">
        <img
          id="image"
          class="h-auto w-full rounded-lg bg-white object-cover shadow-lg"
          src={`${img}-1.png`}
          data-img={`${img}`}
          alt={productName}
        />
      </div>

      <div class="mb-8 flex flex-row justify-center gap-3 lg:mb-0">
        <button data-img-num="1" class="format-thumb w-20 rounded-lg border-2 border-[#5C3F32] p-2 sm:w-24 lg:w-28">
          <img class="h-auto w-full rounded bg-white" src={`${img}-1.png`} alt="Image 1" />
        </button>
        <button data-img-num="2" class="format-thumb w-20 rounded-lg border-2 border-[#5C3F32] p-2 sm:w-24 lg:w-28">
          <img class="h-auto w-full rounded bg-white" src={`${img}-2.png`} alt="Image 2" />
        </button>
      </div>
    </div>

    <!-- COLONNE DROITE -->
    <div class="flex flex-col items-center lg:w-1/2">
      <div class="flex w-full max-w-xl flex-col items-center px-4 text-center lg:px-0">
        <h3 class="mb-3 text-lg font-semibold text-[#5C3F32] sm:text-xl">{t('product.format')}</h3>

        <!-- Conteneur des boutons dynamiques -->
        <div id="formatButtons" class="mb-4 flex gap-3"></div>

        <div class="mb-6 flex items-center gap-4">
          <span id="price" class="text-3xl font-bold text-[#5C3F32] sm:text-4xl">{variants[0]?.price ?? 0}€</span>
          <div class="flex items-center rounded-lg border-2 border-[#5C3F32]">
            <button id="btn-minus" class="px-3 py-2 transition hover:bg-gray-100">-</button>
            <input type="number" id="quantity" value="1" min="1" class="w-16 border-x-2 border-[#5C3F32] py-2 text-center focus:outline-none" />
            <button id="btn-plus" class="px-3 py-2 transition hover:bg-gray-100">+</button>
          </div>
        </div>

        <button
          id="addToCart"
          class="mb-6 w-full max-w-sm rounded-lg bg-[#5C3F32] px-8 py-3 font-bold text-white shadow-lg transition hover:scale-105 hover:bg-[#8B4513]"
          data-product-id={id}
          data-product-name={productName}
          data-product-image={`${img}-1.png`}
          data-variants={JSON.stringify(variants)}
        >
          {t('product.addToCart')}
        </button>

        <p class="mb-6 text-sm text-gray-600">{dimension}</p>
      </div>

      <!-- Tabs -->
      <div class="mt-8 w-full max-w-2xl rounded-lg bg-white p-4 shadow-lg sm:p-6">
        <div class="mb-4 flex justify-center overflow-x-auto border-b border-gray-200">
          <button class="tablinks whitespace-nowrap border-b-2 border-[#5C3F32] px-4 py-2 font-semibold text-[#5C3F32]" data-tab="ingredient">{tabTitles.ingredient}</button>
          <button class="tablinks whitespace-nowrap px-4 py-2 font-semibold text-gray-500 transition hover:text-[#5C3F32]" data-tab="preparation">{tabTitles.preparation}</button>
          <button class="tablinks whitespace-nowrap px-4 py-2 font-semibold text-gray-500 transition hover:text-[#5C3F32]" data-tab="description">{tabTitles.description}</button>
        </div>

        <div id="ingredient" class="tabcontent">
          {formatTextWithLineBreaks(ingredient).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
        <div id="preparation" class="tabcontent hidden">
          {formatTextWithLineBreaks(preparation).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
        <div id="description" class="tabcontent hidden">
          {formatTextWithLineBreaks(description).map((line) => <p class="mb-2 text-gray-700">{line}</p>)}
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const quantityInput = document.getElementById('quantity') as HTMLInputElement | null;
  const btnMinus = document.getElementById('btn-minus');
  const btnPlus = document.getElementById('btn-plus');
  const addToCartBtn = document.getElementById('addToCart');
  const priceEl = document.getElementById('price');
  const imgBase = document.getElementById('image')?.getAttribute('data-img') ?? '';

  // Variantes dynamiques
  const variants: { format: string; price: number }[] = addToCartBtn
    ? JSON.parse(addToCartBtn.dataset.variants ?? '[]')
    : [];

  // Création des boutons dynamiques
  const formatContainer = document.getElementById('formatButtons');
  let selectedFormat = variants[0]?.format || '';
  const priceMap: Record<string, number> = {};

  variants.forEach((v, i) => {
    priceMap[v.format] = parseFloat(v.price as any);

    const btn = document.createElement('button');
    btn.textContent = v.format;
    btn.className = `rounded-lg border-2 border-[#A47343] px-4 py-2 font-semibold transition sm:px-5 sm:py-2.5 ${
      i === 0 ? 'bg-[#A47343] text-white' : 'text-[#A47343]'
    }`;
    btn.dataset.format = v.format;

    btn.addEventListener('click', () => {
      selectedFormat = v.format;
      if (priceEl) priceEl.textContent = priceMap[selectedFormat].toFixed(2) + '€';

      // Toggle classes
      formatContainer?.querySelectorAll('button').forEach(b => {
        b.classList.remove('bg-[#A47343]','text-white');
        b.classList.add('text-[#A47343]');
      });
      btn.classList.add('bg-[#A47343]','text-white');
      btn.classList.remove('text-[#A47343]');
    });

    formatContainer?.appendChild(btn);
  });

  // Gestion quantité
  btnMinus?.addEventListener('click', () => {
    if (quantityInput && parseInt(quantityInput.value) > 1) {
      quantityInput.value = String(parseInt(quantityInput.value) - 1);
    }
  });
  btnPlus?.addEventListener('click', () => {
    if (quantityInput) quantityInput.value = String(parseInt(quantityInput.value) + 1);
  });

  // Changement image
  document.querySelectorAll<HTMLElement>('.format-thumb').forEach(btn => {
    btn.addEventListener('click', () => {
      const num = btn.dataset.imgNum ?? '1';
      const imgEl = document.getElementById('image') as HTMLImageElement | null;
      if (imgEl) imgEl.src = `${imgBase}-${num}.png`;
    });
  });

  // Tabs
  function openTab(tabName: string) {
    document.querySelectorAll<HTMLElement>('.tabcontent').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll<HTMLElement>('.tablinks').forEach(link => {
      link.classList.remove('border-b-2','border-[#5C3F32]','text-[#5C3F32]');
      link.classList.add('text-gray-500');
    });
    document.getElementById(tabName)?.classList.remove('hidden');
    document.querySelector<HTMLElement>(`.tablinks[data-tab="${tabName}"]`)?.classList.add('border-b-2','border-[#5C3F32]','text-[#5C3F32]');
  }
  document.querySelectorAll<HTMLElement>('.tablinks').forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      if (tabName) openTab(tabName);
    });
  });
  openTab('ingredient');

  // Ajout au panier
  addToCartBtn?.addEventListener('click', () => {
    const quantityValue = parseInt(quantityInput?.value ?? '1');
    const product = {
      id: addToCartBtn.dataset.productId,
      name: addToCartBtn.dataset.productName,
      price: priceMap[selectedFormat],
      image: addToCartBtn.dataset.productImage,
      quantity: quantityValue,
      format: selectedFormat
    };
    window.addToCart?.(product);
    window.dispatchAddToCartModal?.(product);
  });
});
</script>

<style>
  .tabcontent.hidden { display: none; }
  .tabcontent { display: block; }
</style>
