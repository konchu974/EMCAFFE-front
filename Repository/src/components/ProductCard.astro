---
interface Props {
	img: string;
	productName: string;
	description: string;
	ingredient: string;
	preparation: string;
	dimension: string;
	tabTitles: { ingredient: string; preparation: string; description: string };
	t: (key: string) => string;
}

const {
	img,
	productName,
	description,
	ingredient,
	preparation,
	dimension,
	tabTitles,
	t,
} = Astro.props as Props;

function formatTextWithLineBreaks(text: string): string[] {
	return text.split('\n');
}
---

<div class="-mt-24 md:mt-0 m-5 flex flex-col md:m-10 md:flex-row">
    <!-- Left: Image column -->
        <div class="flex flex-col md:flex-row justify-center md:justify-normal md:w-1/2">
            <!-- Image principale (grande, centr√©e sur mobile) -->
            <img
                id="image"
                class="h-auto w-full md:w-2/3 bg-white md:order-2 md:ml-10 rounded-lg shadow-lg"
                src={`${img}-1.png`}
                data-img={`${img}`}
            />
    
            <!-- Miniatures (en dessous sur mobile, √† gauche sur desktop) -->
            <div class="flex flex-row md:flex-col justify-center gap-3 mt-4 md:mt-0 md:order-1">
                <button
                    id="button1"
                    class="w-20 md:w-fit rounded-lg border-2 border-[#5C3F32] p-2 hover:border-[#A47343] transition"
                >
                    <img class="h-auto w-full md:w-16 bg-white rounded" src={`${img}-1.png`} />
                </button>
                <button
                    id="button2"
                    class="w-20 md:w-fit rounded-lg border-2 border-[#5C3F32] p-2 hover:border-[#A47343] transition"
                >
                    <img class="h-auto w-full md:w-16 bg-white rounded" src={`${img}-2.png`} />
                </button>
            </div>
        </div>

	<!-- Right: Product details -->
	<div
		class="my-10 flex flex-col md:w-1/2 bg-white border-2 border-[#000000] rounded-lg p-5"
	>
		<h2 class="text-2xl font-bold text-[#5C3F32] md:text-4xl">{productName}</h2>
		<p class="mt-1 text-sm text-[#A47343]">{dimension}</p>

		<div class="mt-5 w-full overflow-x-auto border-b-2 border-[#5C3F32]">
			<ul class="flex cursor-pointer snap-x list-none">
				<li class="mr-6">
					<button
						class="tablinks border-2 border-b-0 border-[#5C3F32] px-4 py-2 text-xl font-bold text-[#5C3F32] hover:bg-[#A47343]"
						data-tab="ingredient"
					>
						{tabTitles.ingredient}
					</button>
				</li>
				<li class="mr-6">
					<button
						class="tablinks border-b-0 border-[#5C3F32] px-4 py-2 text-xl font-bold text-[#5C3F32] hover:bg-[#A47343]"
						data-tab="preparation"
					>
						{tabTitles.preparation}
					</button>
				</li>
				<li class="mr-6">
					<button
						class="tablinks border-b-0 border-[#5C3F32] px-4 py-2 text-xl font-bold text-[#5C3F32] hover:bg-[#A47343]"
						data-tab="description"
					>
						{tabTitles.description}
					</button>
				</li>
			</ul>
		</div>

		<div id="ingredient" class="tabcontent mt-5 hidden text-base text-[#A47343]">
			{formatTextWithLineBreaks(ingredient).map((line) => (
				<p class="mt-2 text-xl">{line}</p>
			))}
		</div>

		<div id="preparation" class="tabcontent mt-5 hidden text-base text-[#A47343]">
			{formatTextWithLineBreaks(preparation).map((line) => (
				<p class="mt-2 text-xl">{line}</p>
			))}
		</div>

		<div id="description" class="tabcontent mt-5 hidden text-base text-[#A47343]">
			{formatTextWithLineBreaks(description).map((line) => (
				<p class="mt-2 text-xl">{line}</p>
			))}
		</div>
	</div>
</div>

<!-- üü´ Purchase Section OUTSIDE the white container -->
<div class="flex flex-col items-center justify-center text-center my-8">
	<h3 class="text-lg font-semibold text-[#5C3F32] mb-2">{t("product.format")}</h3>
	<div class="flex gap-3 mb-3">
		<button id="btn-250" class="px-3 py-1 bg-[#A47343] text-white font-semibold rounded active">
			250g
		</button>
		<button id="btn-1000" class="px-3 py-1 border border-[#A47343] text-[#A47343] font-semibold rounded hover:bg-[#A47343] hover:text-white transition">
			1kg
		</button>
	</div>

	<div class="flex items-center justify-center gap-3 mb-3">
		<input
			type="number"
			value="1"
			min="1"
			class="w-12 text-center border border-[#A47343] rounded"
		/>
		<span id="price" class="text-xl font-bold text-[#5C3F32]">16,99‚Ç¨</span>
	</div>

	<p class="text-sm text-gray-700 mb-4">
		üöö {t("product.delivery")}<br />
		<span class="text-green-600">‚úî {t("product.instock")}</span>
	</p>

	<button
	    id="addToCart"
		class="bg-black text-white rounded-full px-8 py-3 text-sm md:text-base hover:bg-neutral-800 transition"
	>
		{t("product.addtocart")}
	</button>
</div>

<script is:inline>
	const changeImage = (srcImg, num) => {
		const image = document.getElementById("image");
		if (image && srcImg) {
			image.src = `${srcImg}-${num}.png`;
		}
	};

	const openTab = (tabName) => {
		const tabContentElements = document.querySelectorAll(".tabcontent");
		const tabLinkElements = document.querySelectorAll(".tablinks");

		tabContentElements.forEach((content) => content.classList.add("hidden"));
		tabLinkElements.forEach((link) => link.classList.remove("border-2"));

		const activeTab = document.getElementById(tabName);
		if (activeTab) activeTab.classList.remove("hidden");

		const activeLink = Array.from(tabLinkElements).find(
			(link) => link.getAttribute("data-tab") === tabName
		);
		if (activeLink) activeLink.classList.add("border-2");
	};

	document.addEventListener("DOMContentLoaded", () => {
		const img = document.getElementById("image")?.getAttribute("data-img") || "";
		const btn250 = document.getElementById("btn-250");
		const btn1000 = document.getElementById("btn-1000");
		const priceEl = document.getElementById("price");
		const addToCartBtn = document.getElementById("addToCart");
		const productName =
			document.querySelector("h2")?.textContent?.trim() || "Produit inconnu";
		const quantityInput = document.querySelector("input[type='number']");

		let selectedFormat = "250g";
		let price = 16.99;

		// --- Image switching ---
		document
			.getElementById("button1")
			?.addEventListener("click", () => changeImage(img, "1"));
		document
			.getElementById("button2")
			?.addEventListener("click", () => changeImage(img, "2"));

		// --- Tab system ---
		document.querySelectorAll(".tablinks").forEach((button) => {
			button.addEventListener("click", () => {
				const tabName = button.getAttribute("data-tab");
				if (tabName) openTab(tabName);
			});
		});
		openTab("ingredient");

		// --- Format toggle ---
		if (btn250 && btn1000 && priceEl) {
			btn250.addEventListener("click", () => {
				selectedFormat = "250g";
				price = 16.99;
				btn250.classList.add("bg-[#A47343]", "text-white");
				btn1000.classList.remove("bg-[#A47343]", "text-white");
				priceEl.textContent = "16,99‚Ç¨";
			});

			btn1000.addEventListener("click", () => {
				selectedFormat = "1kg";
				price = 34.99;
				btn1000.classList.add("bg-[#A47343]", "text-white");
				btn250.classList.remove("bg-[#A47343]", "text-white");
				priceEl.textContent = "34,99‚Ç¨";
			});
		}

		// --- Add to Cart button (calls centralized script) ---
		addToCartBtn?.addEventListener("click", () => {
			const quantity = parseInt(quantityInput?.value || "1");

			const product = {
				id: productName.toLowerCase().replace(/\s+/g, "-"),
				name: productName,
				price: price,
				image: `${img}-1.png`,
				format: selectedFormat,
				quantity: quantity,
			};

			if (window.addToCart) {
				window.addToCart(product);
				alert("‚úÖ Produit ajout√© au panier !");
			} else {
				console.error("‚ö†Ô∏è addToCart not found ‚Äî check Layout script import.");
			}
		});
	});
</script>


<style>
	.tabcontent.hidden {
		display: none;
	}
	.tabcontent {
		display: block;
	}
</style>
