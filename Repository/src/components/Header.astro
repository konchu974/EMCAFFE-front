---
import LanguagePicker from '@/components/LanguagePicker.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const isContactRedirect = Astro.url.hash === '#contact';
const isShopPage = Astro.url.pathname === `/${lang}/shop`;
const isHomePage = (isShopPage || isContactRedirect) === false;
---

<header id="header" class={isContactRedirect ? 'sticky' : 'transparent'}>
	<div class="flex w-full items-center justify-between">
		<button
			id="burger-btn"
			class="z-50 flex flex-col gap-1.5 md:hidden"
			aria-label="Toggle menu"
		>
			<span class="burger-line"></span>
			<span class="burger-line"></span>
			<span class="burger-line"></span>
		</button>

		<!-- Logo -->
		<a
			href={`/${lang}/`}
			class="absolute left-1/2 flex -translate-x-1/2 flex-row items-center justify-center gap-x-2 py-2 md:relative md:left-auto md:translate-x-0 md:gap-x-4 md:py-0 lg:gap-x-14"
		>
			<picture>
				<img
					class="h-16 w-auto rounded-full border-2 border-[#013C26] md:h-40 md:border-4"
					src="/img/emca-logo.png"
					alt="EMCA Logo"
				/>
			</picture>
		</a>

		<!-- Icons mobiles -->
		<div class="flex items-center gap-4 md:hidden">
			<!-- Account Icon -->
			<a
				href={`/${lang}/log`}
				id="account-icon-mobile"
				class="text-inherit transition hover:scale-110"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 640 640"
					class="header-icon h-8 w-8 transition-colors duration-300"
					fill="currentColor"
				>
					<path
						d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"
					></path>
				</svg>
			</a>

			<!-- Cart Icon -->
			<a
				href={`/${lang}/cart`}
				class="relative text-inherit transition hover:scale-110"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 576 512"
					class="header-icon h-6 w-6 transition-colors duration-300"
					fill="currentColor"
				>
					<path
						d="M0 24C0 10.7 10.7 0 24 0H69.5c10.6 0 19.9 6.6 23.4 16.6L102.5 48H552c13.3 0 24 10.7 24 24c0 2.4-.4 4.7-1 6.9l-54 192c-5.1 18.2-21.8 30.9-40.7 30.9H192l7.2 32H480c13.3 0 24 10.7 24 24s-10.7 24-24 24H184c-10.6 0-19.9-6.6-23.4-16.6L91.9 32H24C10.7 32 0 21.3 0 8s10.7-8 24-8zM160 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zM400 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0z"
					></path>
				</svg>
				<span
					id="cart-count"
					class="absolute -right-2 -top-2 flex hidden h-4 w-4 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white"
				>
					0
				</span>
			</a>
		</div>

		<!-- Navigation -->
		<nav id="nav-menu" class="nav-menu">
			<ul class="flex flex-col items-center gap-6 md:flex-row md:gap-x-6">
				<!-- Navigation Links -->
				<li
					class="text-lg font-bold font-semibold uppercase hover:text-[#753E1C] md:text-lg md:font-semibold md:normal-case"
				>
					<a href={`/${lang}/`} class="nav-link font-[Chalkduster]"
						>{t('nav.home')}</a
					>
				</li>
				<li
					class="text-lg font-bold font-semibold uppercase hover:text-[#753E1C] md:text-lg md:font-semibold md:normal-case"
				>
					<a
						href={`/${lang}/shop`}
						class="nav-link font-[Chalkduster]"
						>{t('nav.products')}</a
					>
				</li>
				<li
					class="text-lg font-bold font-semibold uppercase hover:text-[#753E1C] md:text-lg md:font-semibold md:normal-case"
				>
					<a
						href={`/${lang}/recipes`}
						class="nav-link font-[Chalkduster]"
						>{t('nav.recipes')}</a
					>
				</li>
				<li
					class="text-lg font-bold font-semibold uppercase hover:text-[#753E1C] md:text-lg md:font-semibold md:normal-case"
				>
					<a
						href={`/${lang}/contact`}
						class="nav-link font-[Chalkduster]"
						>{t('nav.contact')}</a
					>
				</li>


				<!-- Language Picker -->
				<li>
					<LanguagePicker />
				</li>

				<!-- Account Icon (Desktop) -->
				<li class="hidden md:block" id="account-nav-item">
					<a
						href={`/${lang}/log`}
						id="account-icon-desktop"
						class="text-inherit transition hover:scale-110"
						title="Mon compte"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 640 640"
							class="header-icon h-6 w-6 transition-colors duration-300"
							fill="currentColor"
						>
							<path
								d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"
							></path>
						</svg>
					</a>
				</li>

				<!-- Logout Button (shown only when logged in) -->
				<li class="hidden md:block" id="logout-nav-item">
					<button
						id="logout-btn-desktop"
						class="flex items-center gap-2 text-inherit transition hover:scale-110 hover:text-red-600"
						title="Déconnexion"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 512 512"
							class="header-icon h-6 w-6 transition-colors duration-300"
							fill="currentColor"
						>
							<path
								d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"
							></path>
						</svg>
					</button>
				</li>

				<!-- Cart Icon (Desktop) -->
				<li class="relative hidden md:block">
					<a
						href={`/${lang}/cart`}
						class="text-inherit transition hover:scale-110"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 576 512"
							class="header-icon h-6 w-6 transition-colors duration-300"
							fill="currentColor"
						>
							<path
								d="M0 24C0 10.7 10.7 0 24 0H69.5c10.6 0 19.9 6.6 23.4 16.6L102.5 48H552c13.3 0 24 10.7 24 24c0 2.4-.4 4.7-1 6.9l-54 192c-5.1 18.2-21.8 30.9-40.7 30.9H192l7.2 32H480c13.3 0 24 10.7 24 24s-10.7 24-24 24H184c-10.6 0-19.9-6.6-23.4-16.6L91.9 32H24C10.7 32 0 21.3 0 8s10.7-8 24-8zM160 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zM400 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0z"
							></path>
						</svg>
					</a>
					<span
						id="cart-count-desktop"
						class="absolute -right-2 -top-2 flex hidden h-4 w-4 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white"
					>
						0
					</span>
				</li>

				<!-- Logout mobile -->
				<li class="md:hidden" id="logout-mobile-item">
					<button
						id="logout-btn-mobile"
						class="flex w-full items-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-white transition hover:bg-red-700"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 512 512"
							class="h-5 w-5"
							fill="currentColor"
						>
							<path
								d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"
							></path>
						</svg>
						Déconnexion
					</button>
				</li>
			</ul>
		</nav>
	</div>
</header>

<style>
	/* Common header layout */
	.mix-header-styles {
		@apply fixed left-0 top-0 z-50 flex w-full flex-col items-center justify-between gap-y-2 px-3 py-4 md:flex-row md:px-8 lg:px-20;
		transition: background-color 300ms linear;
	}

	/* When scrolled sticky */
	.sticky {
		@apply mix-header-styles bg-beige text-[#753E1C];
	}

	/* Transparent at top page */
	.transparent {
		@apply mix-header-styles bg-transparent text-white;
		background: transparent;
	}

	/*  ICON COLORS */
	.transparent .header-icon {
		color: white;
	}

	.sticky .header-icon {
		color: #753e1c;
	}

	.header-icon {
		transition: color 0.3s ease;
	}

	/*  LINK COLORS */
	.transparent a {
		color: white;
	}

	.sticky a {
		color: #753e1c;
	}

	/*Burger button styles */
	#burger-btn {
		width: 30px;
		height: 24px;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.burger-line {
		display: block;
		width: 100%;
		height: 3px;
		background-color: currentColor;
		transition: all 0.3s ease;
		border-radius: 2px;
	}

	#burger-btn.active .burger-line:nth-child(1) {
		transform: translateY(8px) rotate(45deg);
	}

	#burger-btn.active .burger-line:nth-child(2) {
		opacity: 0;
	}

	#burger-btn.active .burger-line:nth-child(3) {
		transform: translateY(-8px) rotate(-45deg);
	}

	/*Mobile menu styles */
	.nav-menu {
		@apply md:block;
	}

	@media (max-width: 768px) {
		.nav-menu {
			position: fixed;
			top: 0;
			left: -100%;
			width: 75%;
			max-width: 100;
			height: 100vh;
			background-color: var(--mobile-menu-bg, #f5f5dc);
			padding: 80px 20px 20px;
			transition: left 0.3s ease;
			box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
			z-index: 40;
		}

		.nav-menu.active {
			left: 0;
		}

		.nav-menu ul {
			flex-direction: column;
			align-items: flex-start;
			gap: 2rem;
		}

		.nav-menu a,
		.nav-menu .header-icon {
			color: #753e1c !important;
		}
	}
</style>

<script>
	// Elements
	const header = document.getElementById('header');
	const burgerBtn = document.getElementById('burger-btn');
	const navMenu = document.getElementById('nav-menu');
	const navLinks = Array.from(document.querySelectorAll('#nav-menu a'));

	// Auth elements
	const accountIconMobile = document.getElementById('account-icon-mobile');
	const accountIconDesktop = document.getElementById('account-icon-desktop');
	const ordersNavItem = document.getElementById('orders-nav-item');
	const logoutNavItem = document.getElementById('logout-nav-item');
	const logoutMobileItem = document.getElementById('logout-mobile-item');
	const logoutBtnDesktop = document.getElementById('logout-btn-desktop');
	const logoutBtnMobile = document.getElementById('logout-btn-mobile');

	let currentState = false;
	let currentThreshold = header?.offsetTop;
	let isMobile = window.innerWidth < 640;

	const currentPath = window.location.pathname;
	const isEffectEnabled = currentPath.length <= 4;

	// ✅ Check authentication and update UI
	function updateAuthUI() {
		const token = localStorage.getItem('token');
		const isLoggedIn = !!token;

		if (isLoggedIn) {
			// Show orders and logout
			ordersNavItem?.classList.remove('hidden');
			logoutNavItem?.classList.remove('hidden');
			logoutMobileItem?.classList.remove('hidden');

			// Change account icon to orders page
			if (accountIconMobile) {
				accountIconMobile.setAttribute('href', `/${getLang()}/account`);
				accountIconMobile.setAttribute('title', 'Mes commandes');
			}
			if (accountIconDesktop) {
				accountIconDesktop.setAttribute('href', `/${getLang()}/account`);
				accountIconDesktop.setAttribute('title', 'Mes commandes');
			}
		} else {
			// Hide orders and logout
			logoutNavItem?.classList.add('hidden');
			logoutMobileItem?.classList.add('hidden');

			// Keep account icon as login
			if (accountIconMobile) {
				accountIconMobile.setAttribute('href', `/${getLang()}/log`);
				accountIconMobile.setAttribute('title', 'Se connecter');
			}
			if (accountIconDesktop) {
				accountIconDesktop.setAttribute('href', `/${getLang()}/log`);
				accountIconDesktop.setAttribute('title', 'Se connecter');
			}
		}
	}

	// ✅ Logout function
	function handleLogout() {
		if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
			localStorage.removeItem('token');
			localStorage.removeItem('user');
			updateAuthUI();
			window.location.href = `/${getLang()}/`;
		}
	}

	// ✅ Get current language
	function getLang(): string {
		const path = window.location.pathname;
		return path.startsWith('/en') ? 'en' : 'fr';
	}

	// Attach logout handlers
	logoutBtnDesktop?.addEventListener('click', handleLogout);
	logoutBtnMobile?.addEventListener('click', handleLogout);

	// Burger menu toggle
	burgerBtn?.addEventListener('click', () => {
		burgerBtn?.classList.toggle('active');
		navMenu?.classList.toggle('active');
		document.body.style.overflow = navMenu?.classList.contains('active')
			? 'hidden'
			: '';
	});

	// Close menu when clicking on a link
	navLinks.forEach((link) => {
		link.addEventListener('click', () => {
			burgerBtn?.classList.remove('active');
			navMenu?.classList.remove('active');
			document.body.style.overflow = '';
		});
	});

	// Close menu when clicking outside
	document.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (
			navMenu?.classList.contains('active') &&
			!navMenu?.contains(target) &&
			!burgerBtn?.contains(target)
		) {
			burgerBtn?.classList.remove('active');
			navMenu?.classList.remove('active');
			document.body.style.overflow = '';
		}
	});

	// Header scroll effect
	if (isEffectEnabled) {
		window.onload = checkForAlter;
		window.onscroll = checkForAlter;
		window.onresize = function () {
			currentThreshold = header?.offsetTop;
			isMobile = window.innerWidth < 768;

			if (!isMobile && navMenu?.classList.contains('active')) {
				burgerBtn?.classList.remove('active');
				navMenu?.classList.remove('active');
				document.body.style.overflow = '';
			}

			checkForAlter();
		};
	} else {
		alterHeader(true);
	}

	function checkForAlter() {
		if (window.scrollY > (currentThreshold ?? 0)) {
			alterHeader(true);
		} else {
			alterHeader(false);
		}
	}

	function alterHeader(setState: boolean) {
		if (currentState === setState) return;
		currentState = setState;

		if (setState) {
			header?.classList.add('sticky');
			header?.classList.remove('transparent');
		} else {
			header?.classList.add('transparent');
			header?.classList.remove('sticky');
		}
	}

	// ✅ Initialize on page load
	document.addEventListener('DOMContentLoaded', () => {
		updateAuthUI();
		(window as any).updateCartBadge?.();
	});
</script>
