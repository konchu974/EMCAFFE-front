---
import LanguagePicker from '@/components/LanguagePicker.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const isContactRedirect = Astro.url.hash === '#contact';
const isShopPage = Astro.url.pathname === `/${lang}/shop`;
const isHomePage = (isShopPage || isContactRedirect) === false;
---

<header id="header" class={isContactRedirect ? 'sticky' : 'transparent'}>
	<!-- Logo -->
	<a
		href={`/${lang}/`}
		class="flex w-full flex-row items-center justify-center gap-x-2 border-b-2 border-[#753E1C] py-2 md:w-auto md:justify-normal md:gap-x-4 md:border-b-0 md:py-0 lg:gap-x-14"
	>
		<picture>
			<img
				class="h-40 w-auto max-w-xs rounded-full border-4 border-[#013C26] md:max-w-md lg:max-w-lg"
				src="/img/emca-logo.png"
				alt="EMCA Logo"
			/>
		</picture>
	</a>

	<!-- Navigation + Icons -->
	<ul class="flex items-center justify-end gap-x-4 py-2 md:gap-x-6 md:py-0">
		<!-- Navigation Links -->
		<li class="md:text-md text-sm font-semibold hover:text-[#753E1C] md:text-lg">
			<a href={`/${lang}/`}>{t('nav.home')}</a>
		</li>
		<li class="md:text-md text-sm font-semibold hover:text-[#753E1C] md:text-lg">
			<a href={`/${lang}/shop`}>{t('nav.products')}</a>
		</li>
		<li class="md:text-md text-sm font-semibold hover:text-[#753E1C] md:text-lg">
			<a href={`/${lang}/contact`}>{t('nav.contact')}</a>
		</li>

		<!-- Language Picker -->
		<li>
			<LanguagePicker />
		</li>

		<!-- Account Icon -->
		<li>
			<a href={`/${lang}/account`} class="hover:scale-110 transition text-inherit">
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 640 640"
					class="h-6 w-6 transition-colors duration-300 header-icon"
					fill="currentColor"
				>
					<path d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"/>
				</svg>
			</a>
		</li>

		<!-- Cart Icon -->
<li class="relative">
  <a href={`/${lang}/cart`} class="hover:scale-110 transition text-inherit">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 576 512"
      class="h-6 w-6 transition-colors duration-300 header-icon"
      fill="currentColor"
    >
      <path d="M0 24C0 10.7 10.7 0 24 0H69.5c10.6 0 19.9 6.6 23.4 16.6L102.5 48H552c13.3 0 24 10.7 24 24c0 2.4-.4 4.7-1 6.9l-54 192c-5.1 18.2-21.8 30.9-40.7 30.9H192l7.2 32H480c13.3 0 24 10.7 24 24s-10.7 24-24 24H184c-10.6 0-19.9-6.6-23.4-16.6L91.9 32H24C10.7 32 0 21.3 0 8s10.7-8 24-8zM160 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zM400 480a48 48 0 1 1 96 0 48 48 0 1 1 -96 0z"/>
    </svg>
  </a>

  <!-- Small red badge for future cart count -->
  <span id="cart-count"
    class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full w-4 h-4 flex items-center justify-center hidden">
    0
  </span>
</li>

	</ul>
</header>

<style>
	/* Common header layout */
	.mix-header-styles {
		@apply fixed left-0 top-0 z-50 flex w-full flex-col items-center justify-between gap-y-2 px-3 py-4 md:flex-row md:px-8 lg:px-20;
		transition: background-color 300ms linear;
	}

	/* When scrolled sticky */
	.sticky {
		@apply mix-header-styles bg-beige text-[#753E1C];
	}

	/* Transparent at top page */
	.transparent {
		@apply mix-header-styles bg-transparent text-white;
		background: transparent;
	}

	/*  ICON COLORS */
	.transparent .header-icon {
		color: white;
	}

	.sticky .header-icon {
		color: #753e1c;
	}

	.header-icon {
		transition: color 0.3s ease;
	}

	/*  LINK COLORS */
	.transparent a {
		color: white;
	}

	.sticky a {
		color: #753e1c;
	}
</style>

<script>
	const header = document.getElementById('header');
	let currentState = false;
	let currentThreshold = header?.offsetTop;
	let isMobile = window.innerWidth < 640;

	const currentPath = window.location.pathname;
	const isEffectEnabled = currentPath.length <= 4 && !isMobile;

	if (isEffectEnabled) {
		window.onload = checkForAlter;
		window.onscroll = checkForAlter;
		window.onresize = function () {
			currentThreshold = header?.offsetTop;
			isMobile = window.innerWidth < 640;
			checkForAlter();
		};
	} else {
		alterHeader(true);
	}

	function checkForAlter() {
		if (isMobile) return;
		if (window.scrollY > (currentThreshold ?? 0)) {
			alterHeader(true);
		} else {
			alterHeader(false);
		}
	}

	function alterHeader(setState: boolean) {
		if (currentState === setState) return;
		currentState = setState;

		if (setState) {
			header?.classList.add('sticky');
			header?.classList.remove('transparent');
		} else {
			header?.classList.add('transparent');
			header?.classList.remove('sticky');
		}
	}
</script>
