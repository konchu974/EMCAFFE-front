---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const products = [
  { image: "/img/products/200-bio-1.png", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/200-bio-2.png", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/side-1.jpg", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/side-2.jpg", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/side-1-1.jpg", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/side-2-2.jpg", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/savoir-faire.jpg", description: t("productHighlight.descriptionFront") },
  { image: "/img/products/peru.jpg", description: t("productHighlight.descriptionFront") },
];
---

<!-- Hidden JSON for JS -->
<script id="products-data" type="application/json" set:html={JSON.stringify(products)}>
</script>

<section
  class="flex flex-col items-center justify-center bg-[#FFFFFF] p-6 md:p-5 w-9/10 mx-auto text-center shadow-lg relative overflow-hidden"
>
  <div class="relative w-full flex items-center justify-center">
    <img
      id="productImage"
      src={products[0].image}
      alt="Coffee product"
      class="max-h-[500px] object-contain mx-auto rounded-lg transition-opacity duration-700 opacity-100"
    />
  </div>

  <p
    id="productDesc"
    class="mt-6 text-lg md:text-xl text-primary font-bold leading-tight font-[Chalkduster]"
    set:html={products[0].description}
  ></p>

  <div class="mt-6 border border-gray-300 text-black font-semibold text-lg md:text-xl px-6 py-2 rounded-full">
    16,99 €
  </div>

 <a href={`product/297cb5b1-84a4-477a-90e5-e17c43b2455c`}
           class="mt-6 inline-block bg-black text-white px-6 py-3 rounded-xl hover:bg-[#5C3F32] transition font-semibold shadow-md text-center"
          >
            {t('product.details') || 'Détails'}
          </a>
</section>

<script is:inline>
  window.addEventListener("DOMContentLoaded", () => {
    /* =====================================
       LOAD PRODUCTS FROM HIDDEN JSON TAG
    ===================================== */
    const jsonTag = document.getElementById("products-data");
    const products = JSON.parse(jsonTag.textContent);

    const img = document.getElementById("productImage");
    const desc = document.getElementById("productDesc");

    /* =====================================
       SLIDESHOW LOGIC
    ===================================== */
    let current = 0;

    function updateSlide(idx) {
      img.style.opacity = "0";

      setTimeout(() => {
        img.src = products[idx].image;
        desc.innerHTML = products[idx].description;
        img.style.opacity = "1";
      }, 300);
    }

    function nextSlide() {
      current = (current + 1) % products.length;
      updateSlide(current);
    }

    let autoSlide = setInterval(nextSlide, 5000);

    const section = document.querySelector("section");
    section.addEventListener("mouseenter", () => clearInterval(autoSlide));
    section.addEventListener("mouseleave", () => {
      autoSlide = setInterval(nextSlide, 5000);
    });

    /* =====================================
       CART LOGIC (unchanged)
    ===================================== */
    function getCart() {
      try {
        return JSON.parse(localStorage.getItem("cart")) || [];
      } catch {
        return [];
      }
    }

    function saveCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function updateCartCount(cart) {
      const total = cart.reduce((s, i) => s + i.quantity, 0);
      const nodes = document.querySelectorAll(".cart-count, #cart-count");
      nodes.forEach((n) => {
        n.textContent = total;
        n.style.display = total > 0 ? "flex" : "none";
      });
    }

    const addBtn = document.getElementById("addToCart");
    addBtn.addEventListener("click", () => {
      const product = {
        id: addBtn.dataset.productId,
        name: addBtn.dataset.productName,
        price: parseFloat(addBtn.dataset.productPrice),
        image: addBtn.dataset.productImage,
        quantity: 1,
        format: "500g",
      };

      const cart = getCart();
      const found = cart.find((i) => i.id === product.id);

      if (found) found.quantity++;
      else cart.push(product);

      saveCart(cart);
      updateCartCount(cart);
    });

    updateCartCount(getCart());
  });
</script>
